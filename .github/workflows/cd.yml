name: CD

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  GO_VERSION: "1.22"
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/aex

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=sha-${GITHUB_SHA::8}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push images
        run: |
          VERSION=${{ steps.version.outputs.version }}
          REGISTRY=${{ env.ARTIFACT_REGISTRY }}
          
          services=(
            "aex-work-publisher"
            "aex-settlement"
            "aex-bid-gateway"
            "aex-bid-evaluator"
            "aex-contract-engine"
            "aex-provider-registry"
            "aex-trust-broker"
            "aex-identity"
            "aex-gateway"
            "aex-telemetry"
          )
          
          for service in "${services[@]}"; do
            echo "Building and pushing $service..."
            docker build \
              -f "src/$service/Dockerfile" \
              -t "$REGISTRY/$service:$VERSION" \
              -t "$REGISTRY/$service:latest" \
              src/
            
            docker push "$REGISTRY/$service:$VERSION"
            docker push "$REGISTRY/$service:latest"
          done

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event.inputs.environment == 'staging' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
    environment: staging
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run (Staging)
        run: |
          VERSION=${{ needs.build-and-push.outputs.version }}
          REGISTRY=${{ env.ARTIFACT_REGISTRY }}
          
          services=(
            "aex-gateway:8080"
            "aex-work-publisher:8081"
            "aex-bid-gateway:8082"
            "aex-bid-evaluator:8083"
            "aex-contract-engine:8084"
            "aex-provider-registry:8085"
            "aex-trust-broker:8086"
            "aex-identity:8087"
            "aex-settlement:8088"
            "aex-telemetry:8089"
          )
          
          for svc in "${services[@]}"; do
            service="${svc%%:*}"
            
            echo "Deploying $service to staging..."
            gcloud run deploy "$service-staging" \
              --image "$REGISTRY/$service:$VERSION" \
              --region ${{ env.GCP_REGION }} \
              --platform managed \
              --allow-unauthenticated \
              --set-env-vars "ENVIRONMENT=staging" \
              --min-instances 0 \
              --max-instances 5 \
              --memory 512Mi \
              --cpu 1 \
              --quiet
          done

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging]
    if: github.event.inputs.environment == 'production' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    environment: production
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run (Production)
        run: |
          VERSION=${{ needs.build-and-push.outputs.version }}
          REGISTRY=${{ env.ARTIFACT_REGISTRY }}
          
          services=(
            "aex-gateway:8080"
            "aex-work-publisher:8081"
            "aex-bid-gateway:8082"
            "aex-bid-evaluator:8083"
            "aex-contract-engine:8084"
            "aex-provider-registry:8085"
            "aex-trust-broker:8086"
            "aex-identity:8087"
            "aex-settlement:8088"
            "aex-telemetry:8089"
          )
          
          for svc in "${services[@]}"; do
            service="${svc%%:*}"
            
            echo "Deploying $service to production..."
            gcloud run deploy "$service" \
              --image "$REGISTRY/$service:$VERSION" \
              --region ${{ env.GCP_REGION }} \
              --platform managed \
              --no-allow-unauthenticated \
              --set-env-vars "ENVIRONMENT=production" \
              --min-instances 1 \
              --max-instances 100 \
              --memory 1Gi \
              --cpu 2 \
              --quiet
          done

      - name: Create release notes
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Release ${tag}`,
              body: `Automated release for ${tag}\n\nDeployed to production.`,
              draft: false,
              prerelease: false
            });
            console.log(`Created release: ${release.html_url}`);

